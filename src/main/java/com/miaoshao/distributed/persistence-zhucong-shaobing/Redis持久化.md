##Redis持久化
1.RDB快照（snapshot）

    （1）默认情况下Redis将内存数据数据库快照保存在名为dump.rdb的二进制文件中。
    
    （2）设置快照参数，满足N秒内有M次改动，可以保存一次快照。例如：60秒内有1000个键被修改，自动保存一次数据集。
        配置参数为：save 60 1000 
        
    （3）可以手动执行命令生成RDB快照。执行命令为 save或者bgsave可以生成dump.rdb文件。每次执行后生成的文件会覆盖原先的rdb快照文件
      
   
    （4）save和bgsave的区别在哪里？
        （1）Redis借助操作系统的写时复制技术（copy on write,COW），在生成快照的同时，依然可以正常处理写命令。
        （2）简单来说，bgsave子进程是由主线程fork生成的，可以共享主线程所有内存数据。
        （3）bgsave子进程运行后，开始读取主进程的内存数据，写入rdb文件，此时，如果主线程对这些数据也是读操作，那么主线程
        和bgsave子线程互不影响。
        （4）但是如果主线程要修改数据，那么这块数据就会被复制一份，生成一个副本。然后bgsave子进程就会把副本写入rdb文件。
        
        save和bgsave对比
        命令                      save              bgsave
        IO类型                     同步                异步
        是否阻塞其他Redis命令         是              否，生成子进程
        有点                    不消耗额外内存        不阻塞客户端命令
        缺点                    阻塞客户端命令       需要fork子进程，消耗内存
        
    （5）配置自动生成rdb文件后台使用的是bgsave方式！
    
2.AOF（append-only file）

    AOF流程和配置：
        （1）快照功能并不是非常耐久：如果Redis故障停机，那么服务器会丢失最新写入但没有来得及保存到快照中的那些数据。
        
        （2）Redis增加了一个耐久的持久化方式，就是AOF持久化（append only file），将每一个指令记录进文件appendonly.aof中
            （先写入os cache每隔一段时间fsync写入到磁盘。）
            
        （3）通过修改配置文件 #appendonly yes 
        
        （4）每当执行命令时，这个命令就会被追加到aof文件的末尾，这样，Redis重启的时候，就可以通过aof文件中的命令来重建数据集。
        
        （5）可以配置Redis多久将数据fsync到磁盘一次：
            appendfsync always 每次有命令追加到aof文件，文件就执行一次fsync，非常慢，也非常安全
            appnedfsync everysec 每秒fsync一次，足够快，故障时只丢失一秒的数据。
            appendfsync no  从不fsync，将数据交给操作系统，不安全。
            ***备注：推荐大家使用的，也是默认的配置，就是每秒执行一次。这种可以兼顾速度和安全性。
            
    AOD重写：
        （1）AOF会定期根据内存最新数据生成aof文件，重写频率也是可修改：
            auto-aof-rewrite-min-size 64mb //aof文件至少要达到64M才会自动重写，文件太小恢复速度很快，重写意义不大。
            auto-aof-rewrite-percentage 100 //aof文件自上一次重写后文件大小增长了100%再次触发重写。
            ***备注：AOF重写Redis会fork出一个子进程执行，不会对Redis正常命令有影响。类似bgsave。
            
        （2）RDB和AOF，应该用哪一个？
              命令            RDB         AOF
            启动优先级          低          高
            体积               小          大
            恢复速度            快          慢
            数据安全性      容易丢失数据   根据策略决定
           
            ***备注：生产环境都可以启用两种方式，Redis启动时既有rdb文件又有aof文件，则优先选择aof文件恢复数据，因为aof一般数据
                    比较全一点。
                    
##Redis4.0混合持久化
1.为什么要使用混合持久化？

    （1）原因:
        重启Redis时，我们很少使用RDB快照来恢复内存状态，因为会丢失大量数据。通常使用AOF日志重放，但是性能比较慢，这样启动Redis就需要
        花费很长的时间。因此，Redis4.0解决了这个问题，那就是--混合持久化。
        
    （2）开启配置
        aof-use-rdb-preamble yes
    
2.混合持久的过程？
    
    （1）AOF在重写时，不再只是将内存数据写入到aof文件中。而是将这一刻之前的内存做RDB快照处理，并且将RDB快照内容和增量的AOF修改内存数据
    命令村在一起，都写入新的AOF文件，替换之前的AOF文件。
    
    （2）Redis再重启的时候，可以先加载RDB的内容，然后再重放增量AOF日志就可以完全替代之前的全量文件重放。重启效率大大提高。
    
3.Redis数据备份策略？

    1.写个crontab定时调度脚本，每小时copy一份rdb活aof的备份。保留近48小时的备份。
    2.每天保留一份当日的数据，保留最近一个月的备份
    3.每次copy备份，将超时太久的备份删除
    4.每天晚上将当前机器备份复制到其他机器上，以防机器损坏。
    
        
















